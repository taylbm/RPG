###
### index.mako - this is the main page for the dashboard
###

<%!
    inherit_layout = True
    page_id = 'main-page'
    page_title = 'demo-page'
    page_classes = ''
%>

###
### inheritence chain
###

<%inherit file="page.mako" />

###
### namespaces
###

###
### blocks
###




<%block name="extra_header_markup">
<script>
var check_url = "checkmark"
var delete_url = "delete"
if (!String.prototype.format) {
  String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) { 
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}
var RefractiveIndex = 1.21, EarthRadius = 6371.0;
function bool(test)
{
	if (Boolean(test)){val=check_url}else{val=delete_url}
	return val
}
function beamHeight(elevation, slantRange)
{
	return (slantRange * Math.sin(elevation * 3.14159 / 180.0) + (slantRange * slantRange) / (2 * RefractiveIndex * EarthRadius)) * 3280.84;
}

var TestRanges = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
var VcpData = {};
var vcps = []
var i;
var full_dataset = [];

$(document).ready(function(){
	$(".vcp-confirm").on("click", function(){
	    $(".vcp-prompt").html("Are you sure you want to send VCP "+$(this).attr("id")+" to the RDA?")
	    $(".final-vcp-confirm").html("Send VCP "+$(this).attr("id")+" to RDA?")
	});
	$(".vcp-desc").on("click", function() {
	    $(".vcp-desc-title").html("VCP "+$(this).attr("id")+" Description") 
	});
    $(document).bind('IssuesReceived',IssuesReceived)
    $.getJSON("/list_vcps", function(attr){
        $.each(attr, function(i,field){
    	    vcps.push(field)
	    this_vcp = field.toString()
	    VcpData[this_vcp] = []
	});
	$(document).trigger('IssuesReceived');
    });
});
		function IssuesReceived(evt){
		    for (i in vcps){
			(function(i){len = vcps.length-1;
			    $.getJSON("/parse_vcps?VCP="+vcps[i], function(elev){
			    	full_dataset[i] = elev;
				if (vcps[i] == 12){other_sz2 = bool(elev.Elev_attr.Elev_1.phase)}else{other_sz2 = bool(false)}
			        if (vcps[i] == 212 || vcps[i] == 32){
				    if (vcps[i] == 212){other_vcp = 12;avset=check_url}
				    else{other_vcp = 31; avset = delete_url;}
				    sails = (bool(elev.allow_sails))
				    if (Boolean(elev.Elev_attr.Elev_1.phase)){sz2 =check_url}else{sz2=delete_url}
				    num_cuts = elev.unique_elevs
				    split = elev.num_split_cuts
				    batch = elev.num_batch_cuts
				    var rowTemplate = $("#rowTemplateMulti").html()
				    var pageTemplate = $("#pageTemplateMulti").html();
		        	    $("#content").prepend(rowTemplate.format(vcps[i],other_vcp,avset,sails,sz2,other_sz2,num_cuts,split,batch)).trigger("create");
				    $("#top_level").append(pageTemplate.format(vcps[i],other_vcp)).trigger("create")
				}
				else{	
				    if (vcps[i] == 12 || vcps[i] == 31){}
				    else {avset = check_url;sails = bool(elev.allow_sails);sz2 = bool(elev.Elev_attr.Elev_1.phase)
				    num_cuts = elev.unique_elevs 
				    split = elev.num_split_cuts
				    batch = elev.num_batch_cuts
				    var pageTemplate = $("#pageTemplateSingle").html();
				    $("#top_level").append(pageTemplate.format(vcps[i])).trigger("create");
				    }


				    
				}

				if (i==len){
				    var vcpTemplate = $("#vcpPage").html()
    				    var template = Handlebars.compile(vcpTemplate);
    				    var context = {vcp:vcps};
    				    $("#radioContain").html(template(context)).trigger("create");
				$(".vcp-button").on("click", function() {
				    elevation_idx = []
				    vcp = $(this).attr("id")
				    var vcpTable = $("#vcpTable").html()
				    var tableTemplate = Handlebars.compile(vcpTable);
				    var elev_attr = full_dataset[vcps.indexOf(Number(vcp))].Elev_attr
				    elev_nums = Object.keys(elev_attr);
				    full_dataset_sort = [];
				    for (j in elev_nums) {elevation_idx[j] = Number(elev_nums[j].slice(5))};
				    var count = 0;
				    for (var key in elev_attr) {full_dataset_sort[elevation_idx[count]] = (elev_attr[key]); count+=1;}
				    $("#tableContain").html('')
				    $("#tableContain").html(tableTemplate({"Elev_attr":full_dataset_sort})).enhanceWithin();

				});
				}
		var elevs = [];
                $.each(elev.Elev_attr, function(i, field){
		    elevs.push(field.elev_ang_deg);
                });
	        elevs.sort(function(a, b){return a-b});
	        elevs = elevs.filter(Number);
	        
                    $.each(elevs, function (zIdx, zVal) {
                        var lower = {
                            id:     'elev-' + zIdx + '-lower',
                            data:   [],
                            lines:  {
                                lineWidth:  0
                            }
                        };

                        
                        var upper = {
                            id:     'elev-' + zIdx,
                            data:   [],
                            lines:  {
                                lineWidth:  0,
                                fill:       0.5
                            },
                            fillBetween:    'elev-' + zIdx + '-lower'
                        };
                        
                        $.each(TestRanges, function (xIdx, xSlantRange) {
                            lower.data.push([xSlantRange, beamHeight(zVal - 0.5, xSlantRange)]);
                        }); 
                        
                        $.each(TestRanges, function (xIdx, xSlantRange) {
                            upper.data.push([xSlantRange, beamHeight(zVal + 0.5, xSlantRange)]);
                        }); 
			vcp = vcps[i]
			VcpData[vcp].push(lower);
			VcpData[vcp].push(upper);
                   
		     });
	            $(window).resize(function () {
                        var w = $(window).width() * 0.8;
                        $('.vcp-details').width(w).css('width', w + 'px');
			}).trigger("resize");
                        $.plot(
                            $('#vcp'+vcps[i].toString()+'-draw-details'), 
                            VcpData[vcps[i]],
                            {
                                xaxis:  {
				    label:        'km',
				    labelPos:	  'low',
                                    tickDecimals:   0,
                                    min:            0,
                                    max:            100,
                                    tickSize:       4,
                                },
                                yaxis:  {
			 	    label:	  'ft AGL',
				    labelPos:	  'high',
                                    min:            0,
                                    max:            50000,
                                    tickSize:       5000,
                                    tickDecimals:   0
                                }
                            }
                        )

                $.plot(
                    $('#vcp'+vcps[i].toString()+'-draw-overview'), 
                    VcpData[vcps[i]], 
                    {
                        xaxis:  {
                            show:           false,
                            min:            0,
                            max:            100
                        },
                        yaxis:  {
                            show:           false,
                            min:            0,
                            max:            50000
                        }
                    }
                );
		
	    });

	})(i);
    }
}
</script>
<script src="static/handlebars-v3.0.3.js"></script>
</%block>

###
### body
###
            <div data-role="header">
                <a href="#" data-rel="back" class="ui-btn-left ui-btn ui-btn-inline ui-corner-all ui-btn-icon-left ui-icon-back">Back</a>
                <h2>VCP Mode and Control</h2>
            </div>
	        <div id="content">
                <div data-role="popup" id="vcp-desc">
                    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                    <div data-role="header">
                        <h1 class="vcp-desc-title"></h1>
                    </div>
                    <div role="main" class="ui-content">
                        <div id="vcp-desc-text" class="ui-body ui-body-a" style="height:600px; overflow:auto;">
                            <ul type="square" data-role="listview" data-inset="false" style="padding-top:0.5em;">
                                <li data-role="list-divider">Parameters</li>
                            </ul>
                        </div>
                    </div>
                </div>
	        <div data-role="popup" id="vcp-confirm" data-dismissable="true" style="padding:25px;">
                    <div data-role="header">
                        <h1 class="vcp-prompt"></h1>
                    </div>
                    <div role="main" class="ui-content">
                        <h3 class ="final-vcp-confirm"></h3>
                        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline" data-rel="back">Cancel</a>
                        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline" data-rel="back" data-transition="flow">Send</a>
                    </div>
    

            </div>
<%

vcp_list = [x for x in context.keys() if x.isdigit()]

%>
    % for vcp in vcp_list:
        <table data-role="table" id="vcpTable" class="ui-body-d ui-shadow table-stripe ui-responsive" data-column-btn-theme="b" >
        <thead>
        <tr class="ui-bar-d">
        <th data-priority="2" colspan="2" style="text-align:center;">Elevation</th>
        <th data-priority="3" style="text-align:center;">Scan</th>
        <th data-priority="1" style="text-align:center;">DP</th>
        <th data-priority="5" style="text-align:center;">SR</th>
        <th data-priority="6" style="text-align:center;">Waveform</th>
        <th data-priority="7" style="text-align:center;" colspan="2">Sector 1</th>
        <th data-priority="8" style="text-align:center;" colspan="2">Sector 2</th>
        <th data-priority="9" style="text-align:center;" colspan="2">Sector 3</th>
        <th data-priority="10" style="text-align:center;" colspan="3">Signal/Noise Ratio (dB)</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <th style="text-align:center;">#</th><th style="text-align:center;">Deg</th>
        <th style="text-align:center;">Deg/Sec</th>
        <th style="text-align:center;">Y/N</th>
        <th style="text-align:center;">Y/N</th>
        <th style="text-align:center;">Type</th>
        <th style="text-align:center;">Az</th><th style="text-align:center;">PRF #</th>
        <th style="text-align:center;">Az</th><th style="text-align:center;">PRF #</th>
        <th style="text-align:center;">Az</th><th style="text-align:center;">PRF #</th>
        <th style="text-align:center;">Refl</th><th style="text-align:center;">Vel</th><th style="text-align:center;">Width</th>
        </tr>
        <tr>
		<%
        sorted_elevs = sorted([int(elevation.split('_')[1]) for elevation in context.get(vcp).get("Elev_attr")])
		%>
		
		% for elev in sorted_elevs:
			<% elev_name = "Elev_"+str(elev) %>
		
        <tr>
        <td style="text-align:center;">${elev}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("elev_ang_deg")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("scan_rate_dps")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("dual_pol")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("super_res")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("waveform_type")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("Sector_1")}</td>
        <td style="text-align:center;">${context.get(vcp).get("Elev_attr").get(elev_name).get("Sector_1")}</td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <!--{{#each this.SNR_thresh_dB}}-->
        <td style="text-align:center;"></td>
        <!--{{/each}}-->
		
        </tr>	
        <!--{{/each}}-->
		%endfor

        </tbody>
        </table>
	% endfor


<%
vcp_list.remove("212")
vcp_list.remove("12")
vcp_list.remove("31")
vcp_list.remove("32")

%>



		
    % for vcp in vcp_list:
	

			
            <div class="ui-body ui-body-a ui-corner-all">
                <div class="ui-grid-b">
        			<div class="ui-block-a">
        				<div class="ui-grid-a">
        					<ul data-role="listview" data-inset="true" class="ui-block-a ui-listview ui-listview-inset ui-corner-all ui-shadow">
                                    		    <li class="ui-first-child ui-last-child"data-icon="check"><a class="vcp-confirm ui-btn ui-btn-icon-right ui-icon-check" 						    id="${vcp}" href="#vcp-confirm" data-rel="popup">VCP ${vcp}</a></li>
                            </ul>
        					<a class="vcp-page-click ui-block-b" href="#vcp-${vcp}-page">
        					<div id="vcp${vcp}-draw-overview" style="height:80px; width:160px;"></div>
        					</a>	
        				</div>
        			</div>
                    <a class="ui-block-b ui-btn ui-btn-inline ui-btn-notext ui-corner-all">
        			    <table data-role="table" data-mode="reflow" class="ui-responsive ui-table ui-table-reflow">
        			    <thead>
        				<tr>
        				<th><a href="#"><img src="/static/checkmark.png" class="ui-li-icon ui-corner-none">AVSET</a></th>
        				<th><a href="#"><img src="/static/${context.get(vcp).get("sails")}.png" class="ui-li-icon">SAILS</a></th>
        				<th><a href="#"><img src="/static/${context.get(vcp).get("sz2")}.png" class="ui-li-icon">SZ2</a></th>
        				</tr>
        			    </thead>
        			    </table>
        			<p style="font-size:11px" align="left">Elev. Angles: ${int(context.get(vcp).get('unique_elevs'))} # Split Cuts: ${context.get(vcp).get('num_split_cuts')} # Batch Cuts: ${context.get(vcp).get('num_batch_cuts')}</p><p align="left"> Update Interval: N/A</p></a>
                                <a href="#vcp-desc" id="${vcp}" data-rel="popup" class="vcp-desc ui-block-c"><p style="text-indent:0.5em; padding-left:0.5em;">VCP ${vcp} Sample 				Info</p></a>
                </div>


    		</div>

	% endfor

		<script type="text/template" id="pageTemplateSingle">
            <div id="vcp-{0}-page" data-role="page">
                <div data-role="header">
                    <h2>VCP {0} Details</h2>
                    <a href="#" data-rel="back" class="ui-btn-left ui-btn ui-btn-inline ui-corner-all ui-btn-icon-left ui-icon-back">Back</a>
                </div>
                <div role="main" class="ui-content">
                    <h3 class="ui-bar ui-bar-a ui-corner-all">VCP {0}</h3>
                    <div class="ui-body ui-body-a ui-corner-all vcp-details" style="height:600px; width:600px; margin:auto;">
                        <div id="vcp{0}-draw-details" style="height:500px; width: 500px; margin:auto;" class="vcp-details"></div>
                    </div>
                </div>
                <div data-role="footer">
                    <h3>NEXRAD Radar Operations Center</h3>
                </div>
            </div>
		</script>


		<script type="text/template" id="rowTemplateMulti">
                <div class="ui-body ui-body-a ui-corner-all">
                    <div class="ui-grid-b">
			<div class="ui-block-a">
				<div class="ui-grid-a">
					<ul data-role="listview" data-inset="true" class="ui-block-a ui-listview ui-listview-inset ui-corner-all ui-shadow">
                           	 	    <li class="ui-first-child" data-icon="check"><a class="vcp-confirm ui-btn ui-btn-icon-right ui-icon-check" id="{0}" 					    href="#vcp-confirm" data-rel="popup">VCP {0}</a></li>
                            		    <li class="ui-last-child" data-icon="check"><a class="vcp-confirm ui-btn ui-btn-icon-right ui-icon-check" id="{1}" 					    	    href="#vcp-confirm" data-rel="popup">VCP {1}</a></li>
                       			</ul>
					<a class="vcp-page-click ui-block-b" href="#vcp-{0}-page">
					<div id="vcp{0}-draw-overview" style="height:80px; width:160px;"></div>
					</a>		
				</div>
			</div>
                        <a class="vcp-multi ui-block-b ui-btn ui-corner-all ui-btn ui-btn-inline ui-btn-notext ui-corner-all">
			    <table data-role="table" data-mode="reflow" class="ui-responsive ui-table ui-table-reflow">
			    <thead>
			        <tr>
			        <th><a href="#"><img src="/static/{2}.png" class="ui-li-icon ui-corner-none">AVSET</a></th>
				<th><a href="#"><img src="/static/{3}.png" class="ui-li-icon">SAILS</a></th>
				<th><a href="#"><img src="/static/{4}.png" class="ui-li-icon">SZ2</a></th>
				</tr>
			    </thead>
			    </table>
			    <table data-role="table" data-mode="reflow" class="ui-responsive ui-table ui-table-reflow">
			    <thead>
				<tr>
				<th><a href="#"><img src="/static/{2}.png" class="ui-li-icon ui-corner-none">AVSET</a></th>
				<th><a href="#"><img src="/static/{3}.png" class="ui-li-icon">SAILS</a></th>
				<th><a href="#"><img src="/static/{5}.png" class="ui-li-icon">SZ2</a></th>
				</tr>
				</thead>
				</table>
			<p style="font-size:11px" align="left">Elev. Angles: {6} # Split Cuts: {7} # Batch Cuts: {8}</p><div style="height:80px; width:160px;">
			<p align="left"> Update Interval: N/A</p>
			</div>
			</a>
                        <a href="#vcp-desc" id="{0}/{1}" data-rel="popup" class="vcp-desc ui-block-c"><p style="text-indent:0.5em; padding-left:0.5em;">VCP {0} 			Sample Info</p><p style="text-indent:0.5em; padding-left:0.5em;">VCP {1} Sample Info</p>
			</a>
                    </div>
                </div>
	</script>




	<script type="text/template" id="pageTemplateMulti">
        <div id="vcp-{0}-page" data-role="page">
            <div data-role="header">
                <h2>VCP {0}/{1} Details</h2>
                <a href="#" data-rel="back" class="ui-btn-left ui-btn ui-btn-inline ui-corner-all ui-btn-icon-left ui-icon-back">Back</a>
            </div>
            <div role="main" class="ui-content">
                <h3 class="ui-bar ui-bar-a ui-corner-all">VCP {0}/{1}</h3>
                <div class="ui-body ui-body-a ui-corner-all vcp-details" style="height:600px; width:600px; margin:auto;">
                    <div id="vcp{0}-draw-details" style="height:500px; width: 500px; margin:auto;" class="vcp-details"></div>
                </div>
            </div>
            <div data-role="footer">
                <h3>NEXRAD Radar Operations Center</h3>
            </div>
        </div>
	</script>



	<script type="text/x-handlebars-template" id="vcpPage">
            	<form>
	    	    <fieldset  id="vcpselector" class="ui-controlgroup ui-controlgroup-horizontal ui-corner-all" data-role="controlgroup" data-type="horizontal">
			<legend>VCP:</legend><div class="ui-controlgroup-controls">
			{{#each vcp}}
			<div class="ui-radio">
			<input type="radio" name="vcp-choice" id="{{this}}" value="off">
			<label id="{{this}}" class="vcp-button ui-btn ui-corner-all ui-btn-inherit ui-radio-off" for="{{this}}">{{this}}</label>
			</div>
			{{/each}}
	    	    </fieldset>
	    	</form>
	</script>  

                <div style="display:inline-block">
                    <form>
                        <fieldset data-role="controlgroup" data-type="horizontal">
                            <input type="radio" name="vel-select" id="vel-1" value="on" checked="checked">
                            <label for="vel-1">0.97kts</label>
                            <input type="radio" name="vel-select" id="vel-2" value="off">
                            <label for="vel-2">1.94kts</label>
                        </fieldset>
                    </form>
				</div>	
				
				<div style="display:inline-block;float:right"
	                <div data-role="controlgroup" data-type="horizontal">
	                   <a href="#vcp-def" class="ui-btn ui-corner-all">View RPG VCP Definitions</a>
	                   <a href="#vcp-def" class="ui-btn ui-corner-all">View Current VCP</a>
	                   <a href="#" class="ui-btn ui-corner-all">Restart Current VCP</a>
	                </div>
                </div>
            <div data-role="footer">	                
                <h3>NEXRAD Radar Operations Center</h3>
            </div>
</div>


